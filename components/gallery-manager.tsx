"use client";

import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { Calendar, User, Eye, ArrowLeft, Upload, Trash2, Edit } from "lucide-react";
import { uploadFile } from "@/lib/storage-adapter";
import { blockTranslationFeedback, createAdminButtonHandler } from "@/lib/translation-utils";
import { AdminUploadDialog } from "./admin-upload-dialog";
import { AdminFeaturedUploadDialog } from "./admin-featured-upload-dialog";
import { AdminEventsUploadDialog } from "./admin-events-upload-dialog";

// Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖú ÌÉÄÏûÖ (Î©îÎ™®Ïû•Í≥º ÎèôÏùºÌïú Íµ¨Ï°∞)
export interface GalleryItem {
  id: string;
  title: string;
  content: string;
  author: string;
  imageUrl?: string;
  publishDate: string;
  tags?: string[];
  isPublished: boolean;
  type: 'gallery' | 'featured' | 'events' | 'normal';
  store?: 'google-play' | 'app-store'; // Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
  storeUrl?: string; // Ïä§ÌÜ†Ïñ¥ URL Ï∂îÍ∞Ä
  appCategory?: 'normal' | 'featured' | 'events'; // Ïï± Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä
  status?: 'published' | 'development' | 'in-review'; // Ïï± ÏÉÅÌÉú Ï∂îÍ∞Ä
}

interface GalleryManagerProps {
  type: 'gallery' | 'featured' | 'events' | 'normal';
  title: string;
  description: string;
  onBack?: () => void;
  isAdmin?: boolean;
}

export function GalleryManager({
  type,
  title,
  description,
  onBack,
  isAdmin = false,
}: GalleryManagerProps) {
  const [items, setItems] = useState<GalleryItem[]>([]);
  const [selectedItem, setSelectedItem] = useState<GalleryItem | null>(null);
  const [likes, setLikes] = useState<{ [key: string]: number }>({});
  const [isUploadDialogOpen, setIsUploadDialogOpen] = useState(false);
  const [editingItem, setEditingItem] = useState<GalleryItem | null>(null);
  const [currentPage, setCurrentPage] = useState(1);
  const itemsPerPage = 6;
  

  // Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖú Î°úÎìú (Î©îÎ™®Ïû•Í≥º ÎèôÏùºÌïú Î∞©Ïãù)
  const loadItems = async () => {
    try {
      const response = await fetch(`/api/gallery?type=${type}`);
      if (response.ok) {
        const data = await response.json();
        
        // All apps (gallery)ÏóêÏÑúÎäî reviewÏôÄ published ÏÉÅÌÉúÏùò Ïπ¥ÎìúÎì§ÏùÑ Î™®Îëê ÌëúÏãú
        if (type === 'gallery') {
          const filteredData = data.filter((item: GalleryItem) => 
            item.isPublished || item.status === 'in-review' || item.status === 'published'
          );
          setItems(filteredData);
        } else {
          // FeaturedÏôÄ EventsÎäî Í∏∞Ï°¥ Î°úÏßÅ Ïú†ÏßÄ
          const filteredData = data.filter((item: GalleryItem) => item.isPublished);
          setItems(filteredData);
        }
        
      }
    } catch (error) {
    }
  };

  useEffect(() => {
    loadItems();

    // Ï¢ãÏïÑÏöî Ï†ïÎ≥¥ Î°úÎìú
    const savedLikes = localStorage.getItem(`gallery-likes-${type}`);
    if (savedLikes) {
      setLikes(JSON.parse(savedLikes));
    }

    // Î≤àÏó≠ ÌîºÎìúÎ∞± Ï∞®Îã®
    const blockTranslationFeedback = () => {
      try {
        const selectors = [
          '[class*="goog-"]',
          '[id*="goog-"]',
        ];
        selectors.forEach(selector => {
          document.querySelectorAll(selector).forEach(el => {
            Object.assign((el as HTMLElement).style, {
              display: 'none',
              visibility: 'hidden',
              opacity: '0',
              pointerEvents: 'none',
              position: 'absolute',
              zIndex: '-9999',
              left: '-9999px',
              top: '-9999px',
            });
          });
        });
      } catch {
        // ÏóêÎü¨ Î¨¥Ïãú
      }
    };

    const observer = new MutationObserver(() => blockTranslationFeedback());
    observer.observe(document.body, {
      childList: true,
      subtree: true,
    });

    blockTranslationFeedback();

    return () => observer.disconnect();
  }, [type]);

  // Ï¢ãÏïÑÏöî Ìï∏Îì§Îü¨
  const handleLike = (id: string) => {
    setLikes((prev) => {
      const updated = {
        ...prev,
        [id]: (prev[id] || 0) + 1,
      };
      localStorage.setItem(
        `gallery-likes-${type}`,
        JSON.stringify(updated)
      );
      return updated;
    });
  };

  // Ìé∏Ïßë Ìï∏Îì§Îü¨
  const handleEdit = (item: GalleryItem) => {
    setEditingItem(item);
  };

  // Ìé∏Ïßë ÏôÑÎ£å Ìï∏Îì§Îü¨
  const handleEditComplete = async (updatedItem: GalleryItem, oldType: string, newType: string) => {
    try {
      // ÌÉÄÏûÖÏù¥ Î≥ÄÍ≤ΩÎêú Í≤ΩÏö∞ ÌäπÎ≥Ñ Ï≤òÎ¶¨
      if (oldType !== newType) {
(`üîÑ ÌÉÄÏûÖ Î≥ÄÍ≤Ω ÏãúÏûë: ${oldType} ‚Üí ${newType}`);
        
        // 1. Í∏∞Ï°¥ ÌÉÄÏûÖÏóêÏÑú ÏÇ≠Ï†ú
(`üóëÔ∏è Í∏∞Ï°¥ ÌÉÄÏûÖÏóêÏÑú ÏÇ≠Ï†ú: /api/gallery?type=${oldType}&id=${updatedItem.id}`);
        const deleteResponse = await fetch(`/api/gallery?type=${oldType}&id=${updatedItem.id}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
        });

        if (!deleteResponse.ok) {
          const deleteError = await deleteResponse.text();
          alert(`Í∏∞Ï°¥ Ïπ¥Îìú ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${deleteResponse.status}`);
          return;
        }

        // 2. ÏÉà ÌÉÄÏûÖÏúºÎ°ú ÏÉùÏÑ±
        const createResponse = await fetch(`/api/gallery?type=${newType}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ item: updatedItem }),
        });

        if (createResponse.ok) {
          // Î°úÏª¨ ÏÉÅÌÉúÏóêÏÑú Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
          setItems(prev => prev.filter(item => item.id !== updatedItem.id));                                                                          
          setEditingItem(null);
          alert(`Ïπ¥ÎìúÍ∞Ä ${oldType}ÏóêÏÑú ${newType}Î°ú Ïù¥ÎèôÎêòÏóàÏäµÎãàÎã§.`);
          // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
          loadItems();
        } else {
          const createError = await createResponse.text();
          alert(`ÏÉà ÌÉÄÏûÖÏúºÎ°ú Ïù¥ÎèôÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${createResponse.status}`);
        }
      } else {
        // ÌÉÄÏûÖÏù¥ ÎèôÏùºÌïú Í≤ΩÏö∞ Í∏∞Ï°¥ Ìé∏Ïßë Î°úÏßÅ
        const response = await fetch(`/api/gallery?type=${type}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ item: updatedItem }),
        });

        if (response.ok) {
          // Î°úÏª¨ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
          setItems(prev => prev.map(item => 
            item.id === updatedItem.id ? updatedItem : item
          ));
          setEditingItem(null);
          alert('Ìé∏ÏßëÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
        } else {
          const editError = await response.text();
          alert(`Ìé∏ÏßëÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§: ${response.status}`);
        }
      }
    } catch (error) {
      alert('Ìé∏Ïßë Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };

  // ÏÇ≠Ï†ú Ìï∏Îì§Îü¨
  const handleDelete = (itemId: string) => {
    createAdminButtonHandler(async () => {
      const item = items.find(item => item.id === itemId);
      if (confirm(`"${item?.title}"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
        try {
          // API Ìò∏Ï∂úÎ°ú ÏÇ≠Ï†ú
          const response = await fetch(`/api/gallery?type=${type}&id=${itemId}`, {
            method: 'DELETE',
            headers: {
              'Content-Type': 'application/json',
            },
          });

          if (response.ok) {
            // Î°úÏª¨ ÏÉÅÌÉúÏóêÏÑú Ï†úÍ±∞
            setItems(prev => prev.filter(item => item.id !== itemId));
          } else {
            alert('ÏÇ≠Ï†úÏóê Ïã§Ìå®ÌñàÏäµÎãàÎã§.');
          }
        } catch (error) {
          alert('ÏÇ≠Ï†ú Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
        }
      }
    })();
  };

  // ÏóÖÎ°úÎìú ÏÑ±Í≥µ Ìï∏Îì§Îü¨
  const handleUploadSuccess = () => {
    loadItems(); // Î™©Î°ù ÏÉàÎ°úÍ≥†Ïπ®
    setIsUploadDialogOpen(false);
  };

  // ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Í≥ÑÏÇ∞
  const totalPages = Math.ceil(items.length / itemsPerPage);
  const startIndex = (currentPage - 1) * itemsPerPage;
  const endIndex = startIndex + itemsPerPage;
  const currentItems = items.slice(startIndex, endIndex);

  // ÌéòÏù¥ÏßÄ Î≥ÄÍ≤Ω Ìï∏Îì§Îü¨
  const handlePageChange = (page: number) => {
    setCurrentPage(page);
    // ÌéòÏù¥ÏßÄ ÏÉÅÎã®ÏúºÎ°ú Ïä§ÌÅ¨Î°§ (requestAnimationFrameÏúºÎ°ú ÏµúÏ†ÅÌôî)
    requestAnimationFrame(() => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
  };

  // Ìé∏Ïßë Î∑∞
  if (editingItem) {
    return (
      <div className="space-y-6">
        {/* ‚Üê Back Î≤ÑÌäº */}
        <div className="flex items-center gap-4">
          <Button
            variant="outline"
            onClick={() => setEditingItem(null)}
            className="bg-[#2e2e2e] text-white hover:bg-[#444] border border-gray-700 hover:border-gray-500 transition"
            onMouseEnter={blockTranslationFeedback}
          >
            <span className="notranslate" translate="no">‚Üê Back to Gallery</span>
          </Button>
        </div>

        {/* Ìé∏Ïßë Ìèº */}
        <div className="w-full max-w-2xl mx-auto px-8 sm:px-12 lg:px-16" style={{ maxWidth: '672px' }}>
          <div className="bg-gray-800 border border-gray-700 rounded-lg p-6">
            <h2 className="text-2xl font-bold text-white mb-6">Edit {type} Item</h2>
            
            <form onSubmit={(e) => {
              e.preventDefault();
              const formData = new FormData(e.currentTarget);
              const newType = formData.get('cardType') as 'featured' | 'events';
              const updatedItem: GalleryItem = {
                ...editingItem,
                title: formData.get('title') as string,
                content: formData.get('content') as string,
                author: formData.get('author') as string,
                tags: (formData.get('tags') as string)?.split(',').map(tag => tag.trim()).filter(Boolean) || [],
                store: (formData.get('store') as 'google-play' | 'app-store') || 'google-play',
                storeUrl: formData.get('storeUrl') as string || undefined,
                type: newType,
              };
              handleEditComplete(updatedItem, editingItem.type, newType);
            }} className="space-y-4">
              
              {/* Title */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Title</label>
                <input
                  type="text"
                  name="title"
                  defaultValue={editingItem.title}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>

              {/* Author */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Author</label>
                <input
                  type="text"
                  name="author"
                  defaultValue={editingItem.author}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>

              {/* Content */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Content</label>
                <textarea
                  name="content"
                  defaultValue={editingItem.content}
                  rows={6}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                  required
                />
              </div>

              {/* Card Type */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Card Type</label>
                <select
                  name="cardType"
                  defaultValue={editingItem.type}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="featured">Featured Card</option>
                  <option value="events">Events Card</option>
                </select>
              </div>

              {/* Store */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Store</label>
                <select
                  name="store"
                  defaultValue={editingItem.store || 'google-play'}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                  <option value="google-play">Google Play Store</option>
                  <option value="app-store">App Store</option>
                </select>
              </div>

              {/* Store URL */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Store URL (Optional)</label>
                <input
                  type="url"
                  name="storeUrl"
                  defaultValue={editingItem.storeUrl || ''}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              {/* Tags */}
              <div>
                <label className="block text-sm font-medium text-white mb-2">Tags (comma-separated)</label>
                <input
                  type="text"
                  name="tags"
                  defaultValue={editingItem.tags?.join(', ') || ''}
                  className="w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-md text-white focus:outline-none focus:ring-2 focus:ring-blue-500"
                />
              </div>

              {/* Buttons */}
              <div className="flex gap-4 pt-4">
                <Button
                  type="button"
                  variant="outline"
                  onClick={() => setEditingItem(null)}
                  className="bg-gray-700 text-white border-gray-600 hover:bg-gray-600"
                >
                  Cancel
                </Button>
                <Button
                  type="submit"
                  className="bg-blue-600 hover:bg-blue-700 text-white"
                >
                  Save Changes
                </Button>
              </div>
            </form>
          </div>
        </div>
      </div>
    );
  }

  // ÏÑ∏Î∂Ä Î∑∞
  if (selectedItem) {
    return (
      <div className="space-y-6">
        {/* ‚Üê Back Î≤ÑÌäº */}
        <div className="flex items-center gap-4">
          <Button
            variant="outline"
            onClick={() => setSelectedItem(null)}
            className="bg-[#2e2e2e] text-white hover:bg-[#444] border border-gray-700 hover:border-gray-500 transition"
            onMouseEnter={blockTranslationFeedback}
          >
            <span className="notranslate" translate="no">‚Üê Back to Gallery</span>
          </Button>
        </div>

        {/* Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖú Î∑∞ */}
        <div className="w-full max-w-2xl mx-auto px-8 sm:px-12 lg:px-16" style={{ maxWidth: '672px' }}>
          {/* Ìó§Îçî */}
          <div className="border-b border-gray-600 pb-4 mb-6" onMouseEnter={blockTranslationFeedback}>
            <h1 className="text-3xl font-bold text-white mb-2" translate="no">{selectedItem.title}</h1>
            <div className="flex items-center gap-4 text-gray-400 text-sm">
              <span className="flex items-center gap-1"><User className="h-4 w-4" /><span translate="no">{selectedItem.author}</span></span>
              <span className="flex items-center gap-1"><Calendar className="h-4 w-4" />{new Date(selectedItem.publishDate).toLocaleDateString()}</span>
              
              {!selectedItem.isPublished && (
                <Badge variant="secondary" className="text-xs">ÏûÑÏãúÏ†ÄÏû•</Badge>
              )}
            </div>
          </div>

          {/* Ïù¥ÎØ∏ÏßÄ */}
          {selectedItem.imageUrl && (
            <div className="mb-6 flex justify-center">
              <img
                src={selectedItem.imageUrl}
                alt={selectedItem.title}
                className="w-full max-h-[32rem] object-contain rounded-lg border border-gray-600"
              />
            </div>
          )}

          {/* Î≥∏Î¨∏ */}
          <article className="prose prose-invert dark:prose-invert" onMouseEnter={blockTranslationFeedback}>
            <pre
              className="text-gray-300 whitespace-pre-wrap leading-relaxed max-w-none font-mono"
              style={{ wordWrap: "break-word" }}
            >
              {selectedItem.content}
            </pre>
          </article>

          {/* ÌÉúÍ∑∏ */}
          {selectedItem.tags && selectedItem.tags.length > 0 && (
            <div className="flex flex-wrap gap-1 mb-2 mt-6" onMouseEnter={blockTranslationFeedback}>
              {selectedItem.tags.map((tag, idx) => (
                <span key={idx} className="text-xs px-2 py-0 rounded" style={{ backgroundColor: '#fff', color: '#000' }}>
                  {tag}
                </span>
              ))}
            </div>
          )}

          {/* Ï¢ãÏïÑÏöî */}
          <div className="flex justify-start mt-6 pt-6 border-t border-gray-600" onMouseEnter={blockTranslationFeedback}>
            <button
              onClick={() => handleLike(selectedItem.id)}
              className="flex items-center gap-2 px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-lg transition-colors duration-200 group"
            >
              <span className="text-2xl group-hover:scale-110 transition-transform">üëç</span>
              <span className="text-sm font-medium">{likes[selectedItem.id] || 0}</span>
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Í∏∞Î≥∏ Î™©Î°ù Î∑∞
  return (
    <div className="space-y-6">
      {/* Ï†úÎ™© Î∞è ÏÑ§Î™Ö */}
      <div className="flex flex-col items-center justify-center space-y-4">
        <div className="text-center">
          <h2 className="text-2xl font-bold text-white">{title}</h2>
          <p className="text-gray-400" onMouseEnter={blockTranslationFeedback}>{description}</p>
        </div>
        
        {/* Í¥ÄÎ¶¨Ïûê ÏóÖÎ°úÎìú Î≤ÑÌäº */}
       {isAdmin && type !== 'normal' && (
  <Button
    onClick={() => setIsUploadDialogOpen(true)}
    className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 text-sm font-medium rounded-lg shadow-lg transition-all duration-200 hover:scale-105"
    onMouseEnter={blockTranslationFeedback}
  >
    <Upload className="h-4 w-4 mr-2" />
    Í∞§Îü¨Î¶¨ ÏóÖÎ°úÎìú
  </Button>
)}

        {onBack && (
          <Button
            variant="outline"
            onClick={onBack}
            className="bg-[#2e2e2e] text-white hover:bg-[#444] border border-gray-700 hover:border-gray-500 transition"
            onMouseEnter={blockTranslationFeedback}
          >
            <ArrowLeft className="h-4 w-4 mr-2" />
            Îí§Î°úÍ∞ÄÍ∏∞
          </Button>
        )}
      </div>

      {/* Í∞§Îü¨Î¶¨ Ïπ¥Îìú Í∑∏Î¶¨Îìú - Í∏∞Î≥∏ Í∞§Îü¨Î¶¨ Ïπ¥ÎìúÏôÄ ÎèôÏùºÌïú Î™®Ïñë */}
      <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4">
        {currentItems.length === 0 ? (
          <div className="col-span-full">
            <Card className="bg-gray-800 border-gray-700">
              <CardContent className="p-8 text-center text-gray-400">
                {items.length === 0 ? 'ÏïÑÏßÅ ÏóÖÎ°úÎìúÎêú Í∞§Îü¨Î¶¨ ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.' : 'Ïù¥ ÌéòÏù¥ÏßÄÏóêÎäî Îçî Ïù¥ÏÉÅ ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.'}
              </CardContent>
            </Card>
          </div>
        ) : (
          currentItems.map((item, index) => (
            <Card
              key={item.id}
              className="group overflow-hidden hover:shadow-lg transition-all duration-300 hover:-translate-y-1"
              style={{ backgroundColor: '#D1E2EA' }}
              onMouseEnter={blockTranslationFeedback}
            >
              <div className="relative">
                {/* Screenshot/App Preview */}
                <div className="aspect-square overflow-hidden bg-gradient-to-br from-blue-50 to-purple-50 relative">
                  {item.imageUrl ? (
                    <img
                      src={item.imageUrl}
                      alt={item.title}
                      className="w-full h-full object-cover object-center transition-transform duration-300 group-hover:scale-105"
                    />
                  ) : (
                    <div className="absolute inset-0 w-full h-full flex items-center justify-center text-6xl">
                      üì±
                    </div>
                  )}
                </div>

                {/* Status Badge */}
                <div className="absolute bottom-2 left-2">
                  <Badge className="bg-green-500 text-white text-xs">
                    {item.appCategory || item.type}
                  </Badge>
                </div>

                {/* Event Number Badge - Events ÌÉÄÏûÖÏùº ÎïåÎßå ÌëúÏãú */}
                {type === 'events' && (
                  <div className="absolute top-2 left-2">
                    <Badge className="bg-purple-600 text-white text-lg font-bold w-8 h-8 flex items-center justify-center">
                      {startIndex + index + 1}
                    </Badge>
                  </div>
                )}

                {/* Admin Buttons - Edit and Delete */}
                {isAdmin && (
                  <div className="absolute top-2 right-2 flex gap-1">
                    {/* Edit Button */}
                    <Button
                      size="sm"
                      variant="outline"
                      className="h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200 bg-blue-600 hover:bg-blue-700 border-blue-600 text-white"
                      onClick={() => handleEdit(item)}
                      onMouseEnter={blockTranslationFeedback}
                    >
                      <Edit className="h-3 w-3" />
                    </Button>
                    {/* Delete Button */}
                    <Button
                      size="sm"
                      variant="destructive"
                      className="h-6 w-6 p-0 opacity-0 group-hover:opacity-100 transition-opacity duration-200"
                      onClick={() => handleDelete(item.id)}
                      onMouseEnter={blockTranslationFeedback}
                    >
                      <Trash2 className="h-3 w-3" />
                    </Button>
                  </div>
                )}
              </div>

              <CardContent className="px-2 py-0" style={{ backgroundColor: '#D1E2EA' }}>
                {/* App Icon and Basic Info */}
                <div className="flex items-start space-x-3 mb-2">
                  <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-100 to-purple-100 flex items-center justify-center flex-shrink-0">
                    <span className="text-2xl">üì±</span>
                  </div>
                  <div className="flex-1 min-w-0">
                    <h3 className="font-semibold text-base mb-1 truncate notranslate" translate="no">{item.title}</h3>
                    <p className="text-sm text-muted-foreground truncate notranslate" translate="no">{item.author}</p>
                  </div>
                </div>

                {/* Rating and Stats */}
                <div className="flex items-center justify-between text-sm text-muted-foreground mb-2">
                  <div className="flex items-center space-x-3">
                    <div className="flex items-center gap-1">
                      <Calendar className="h-4 w-4 text-gray-500" />
                      <span>{new Date(item.publishDate).toLocaleDateString()}</span>
                    </div>
                  </div>
                </div>

                {/* Tags */}
                {item.tags && item.tags.length > 0 && (
                  <div className="flex flex-wrap gap-1 mb-0">
                    {item.tags.slice(0, 2).map((tag, index) => (
                      <Badge key={index} variant="secondary" className="text-xs px-2 py-0">
                        {tag}
                      </Badge>
                    ))}
                    {item.tags.length > 2 && (
                      <span className="text-xs text-muted-foreground">
                        +{item.tags.length - 2}
                      </span>
                    )}
                  </div>
                )}
              </CardContent>

              {/* Store Links Section */}
              <div className="w-full bg-[#84CC9A] border-t border-gray-300 px-4 py-2">
                <div className="flex flex-col items-center space-y-2">
                  <Button
                    size="sm"
                    className="h-6 px-3 text-xs bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-1 whitespace-nowrap"
                    onClick={() => {
                      if (item.storeUrl) {
                        // Ïù¥Î≤§Ìä∏ Ïπ¥ÎìúÏùò memo2Îäî ÌòÑÏû¨ ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞
                        const isEventMemo2 = item?.type === 'events' && item?.storeUrl?.includes('/memo2');
                        const openTarget = isEventMemo2 ? '_self' : '_blank';
                        window.open(item.storeUrl, openTarget);
                      } else {
                        const searchQuery = encodeURIComponent(item.title);
                        if (item.store === 'google-play') {
                          window.open(`https://play.google.com/store/search?q=${searchQuery}&c=apps`, '_blank');
                        } else if (item.store === 'app-store') {
                          window.open(`https://apps.apple.com/search?term=${searchQuery}`, '_blank');
                        } else {
                          // Í∏∞Î≥∏Í∞íÏúºÎ°ú Íµ¨Í∏ÄÌîåÎ†àÏù¥ ÏÇ¨Ïö©
                          window.open(`https://play.google.com/store/search?q=${searchQuery}&c=apps`, '_blank');
                        }
                      }
                    }}
                  >
                    <User className="h-3 w-3" />
                    See App
                  </Button>
                  
                  {/* Store Badge - ÏÑ†ÌÉùÎêú Ïä§ÌÜ†Ïñ¥Ïóê Îî∞Îùº ÎèôÏ†Å ÌëúÏãú */}
                  {item.store && (
                    <div className="flex gap-2">
                      <img 
                        src={item.store === 'google-play' ? "/google-play-badge.png" : "/app-store-badge.png"}
                        alt={item.store === 'google-play' ? "Get it on Google Play" : "Download on the App Store"}
                        className="h-6 cursor-pointer hover:opacity-80 transition-opacity"
                        onClick={() => {
                          if (item.storeUrl) {
                            // Ïù¥Î≤§Ìä∏ Ïπ¥ÎìúÏùò memo2Îäî ÌòÑÏû¨ ÌÉ≠ÏóêÏÑú Ïó¥Í∏∞
                            const isEventMemo2 = item?.type === 'events' && item?.storeUrl?.includes('/memo2');
                            const openTarget = isEventMemo2 ? '_self' : '_blank';
                            window.open(item.storeUrl, openTarget);
                          } else {
                            const searchQuery = encodeURIComponent(item.title);
                            if (item.store === 'google-play') {
                              window.open(`https://play.google.com/store/search?q=${searchQuery}&c=apps`, '_blank');
                            } else {
                              window.open(`https://apps.apple.com/search?term=${searchQuery}`, '_blank');
                            }
                          }
                        }}
                      />
                    </div>
                  )}
                </div>
              </div>
            </Card>
          ))
        )}
      </div>

      {/* ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò - 6Í∞ú Ïù¥ÏÉÅÏùº ÎïåÎßå ÌëúÏãú (EventsÎäî Ï†úÏô∏) */}
      {items.length > itemsPerPage && type !== 'events' && (
        <div className="flex justify-center items-center space-x-2 mt-8">
          {/* Ïù¥Ï†Ñ ÌéòÏù¥ÏßÄ Î≤ÑÌäº */}
          <Button
            variant="outline"
            size="sm"
            onClick={() => handlePageChange(currentPage - 1)}
            disabled={currentPage === 1}
            className="bg-gray-800 text-white border-gray-600 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            onMouseEnter={blockTranslationFeedback}
          >
            ‚Üê
          </Button>

          {/* ÌéòÏù¥ÏßÄ Î≤àÌò∏Îì§ */}
          {Array.from({ length: totalPages }, (_, i) => i + 1).map((page) => (
            <Button
              key={page}
              variant={currentPage === page ? "default" : "outline"}
              size="sm"
              onClick={() => handlePageChange(page)}
              className={
                currentPage === page
                  ? "bg-blue-600 text-white hover:bg-blue-700"
                  : "bg-gray-800 text-white border-gray-600 hover:bg-gray-700"
              }
              onMouseEnter={blockTranslationFeedback}
            >
              PAGE {page}
            </Button>
          ))}

          {/* Îã§Ïùå ÌéòÏù¥ÏßÄ Î≤ÑÌäº */}
          <Button
            variant="outline"
            size="sm"
            onClick={() => handlePageChange(currentPage + 1)}
            disabled={currentPage === totalPages}
            className="bg-gray-800 text-white border-gray-600 hover:bg-gray-700 disabled:opacity-50 disabled:cursor-not-allowed"
            onMouseEnter={blockTranslationFeedback}
          >
            ‚Üí
          </Button>
        </div>
      )}

      {/* ÌéòÏù¥ÏßÄ Ï†ïÎ≥¥ */}
      {items.length > 0 && (
        <div className="text-center text-gray-400 text-sm mt-4" onMouseEnter={blockTranslationFeedback}>
          {startIndex + 1}-{Math.min(endIndex, items.length)} of {items.length} items
        </div>
      )}

      {/* ÏóÖÎ°úÎìú Îã§Ïù¥ÏñºÎ°úÍ∑∏ */}
      {isAdmin && (
        <>
          {type === 'featured' ? (
            <AdminFeaturedUploadDialog
              isOpen={isUploadDialogOpen}
              onClose={() => setIsUploadDialogOpen(false)}
              onUploadSuccess={handleUploadSuccess}
              targetGallery={type}
            />
          ) : type === 'events' ? (
            <AdminEventsUploadDialog
              isOpen={isUploadDialogOpen}
              onClose={() => setIsUploadDialogOpen(false)}
              onUploadSuccess={handleUploadSuccess}
              targetGallery={type}
            />
          ) : (
            <AdminUploadDialog
              isOpen={isUploadDialogOpen}
              onClose={() => setIsUploadDialogOpen(false)}
              onUploadSuccess={handleUploadSuccess}
              targetGallery={type}
            />
          )}
        </>
      )}
    </div>
  );
}
